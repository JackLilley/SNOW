<style>
.uc-root {
  --uc-bg: #f5f6fa;
  --uc-bg2: #ebedf3;
  --uc-surface: #ffffff;
  --uc-border: #e0e2ea;
  --uc-text: #1a1a2e;
  --uc-text2: #5a5d70;
  --uc-text3: #8b8ea3;
  --uc-accent: #1976d2;
  --uc-accent-h: #1565c0;
  --uc-red: #d32f2f;
  --uc-orange: #f57c00;
  --uc-blue: #1976d2;
  --uc-green: #388e3c;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 14px; line-height: 1.5; color: var(--uc-text); background: var(--uc-bg);
  -webkit-font-smoothing: antialiased; min-height: 100vh;
}
.uc-root *, .uc-root *::before, .uc-root *::after { box-sizing: border-box; }

.uc-nav {
  display: flex; align-items: center; gap: 24px; padding: 0 32px; height: 56px;
  background: var(--uc-surface); border-bottom: 1px solid var(--uc-border); position: sticky; top: 0; z-index: 100;
}
.uc-nav-brand { font-size: 16px; font-weight: 700; color: var(--uc-accent); letter-spacing: -0.02em; }
.uc-nav-links { display: flex; gap: 2px; }
.uc-nav-link {
  padding: 6px 14px; font-size: 13px; font-weight: 500; color: var(--uc-text2); margin: 0;
  background: none; border: none; border-radius: 6px; cursor: pointer; font-family: inherit;
}
.uc-nav-link:hover { background: var(--uc-bg2); color: var(--uc-text); }
.uc-nav-link.active { background: rgba(25,118,210,.08); color: var(--uc-accent); }
.uc-nav-pulse { color: var(--uc-accent)!important; font-weight: 600!important; animation: ucPulse 2s infinite; }
@keyframes ucPulse { 0%,100%{opacity:1} 50%{opacity:.6} }

.uc-error {
  display: flex; align-items: center; justify-content: space-between; padding: 10px 32px;
  background: rgba(211,47,47,.06); border-bottom: 1px solid rgba(211,47,47,.15); color: var(--uc-red); font-size: 13px;
}
.uc-content { padding: 28px 32px; max-width: 1200px; width: 100%; margin: 0 auto; }
.uc-btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px; margin: 0;
  padding: 8px 18px; font-size: 13px; font-weight: 500; border: none; border-radius: 8px;
  cursor: pointer; font-family: inherit; white-space: nowrap;
}
.uc-btn:disabled { opacity: .5; cursor: not-allowed; }
.uc-btn-p { background: var(--uc-accent); color: #fff; }
.uc-btn-p:hover:not(:disabled) { background: var(--uc-accent-h); box-shadow: 0 2px 6px rgba(25,118,210,.25); }
.uc-btn-s { background: var(--uc-bg2); color: var(--uc-text); }
.uc-btn-s:hover:not(:disabled) { background: var(--uc-border); }
.uc-btn-g { background: none; color: var(--uc-text2); padding: 6px 10px; }
.uc-btn-g:hover:not(:disabled) { background: var(--uc-bg2); color: var(--uc-text); }

/* Dashboard */
.uc-dash { display: flex; flex-direction: column; gap: 24px; }
.uc-dash-hdr { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
.uc-dash-title { font-size: 24px; font-weight: 600; margin: 0; }
.uc-dash-sub { font-size: 12px; color: var(--uc-text2); }
.uc-dash-acts { display: flex; gap: 8px; }
.uc-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
.uc-stat {
  background: var(--uc-surface); border: 1px solid var(--uc-border); border-radius: 12px;
  padding: 20px; text-align: center; width: 100%; font-family: inherit; color: inherit;
}
button.uc-stat { cursor: pointer; }
button.uc-stat:hover { box-shadow: 0 4px 12px rgba(0,0,0,.08); transform: translateY(-1px); }
.uc-stat-val { font-size: 36px; font-weight: 700; line-height: 1; margin-bottom: 6px; }
.uc-stat-lbl { font-size: 14px; font-weight: 500; color: var(--uc-text2); }
.uc-stat-hint { font-size: 11px; color: var(--uc-text3); margin-top: 4px; }
.uc-stat-tag { font-size: 11px; margin-top: 6px; padding: 2px 8px; border-radius: 99px; display: inline-block; }
.uc-c-accent .uc-stat-val { color: var(--uc-accent); }
.uc-c-red .uc-stat-val { color: var(--uc-red); }
.uc-c-blue .uc-stat-val { color: var(--uc-blue); }
.uc-c-green .uc-stat-val { color: var(--uc-green); }
.uc-tag-r { background: rgba(211,47,47,.08); color: var(--uc-red); }
.uc-tag-b { background: rgba(25,118,210,.08); color: var(--uc-blue); }
.uc-tag-g { background: rgba(56,142,60,.08); color: var(--uc-green); }
.uc-risk-ban {
  display: flex; align-items: center; gap: 10px; padding: 14px 18px; font-size: 14px;
  background: rgba(211,47,47,.06); border: 1px solid rgba(211,47,47,.2); border-radius: 10px; color: var(--uc-red);
}
.uc-qa h3, .uc-vs h3 { font-size: 16px; font-weight: 600; margin: 0 0 12px; }
.uc-qa-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
.uc-qa-card {
  display: flex; align-items: center; gap: 14px; background: var(--uc-surface); border: 1px solid var(--uc-border);
  border-radius: 12px; padding: 16px 18px; cursor: pointer; text-align: left; width: 100%; font-family: inherit; color: inherit;
}
.uc-qa-card:hover:not(:disabled) { border-color: var(--uc-accent); box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.uc-qa-card:disabled { opacity: .5; cursor: not-allowed; }
.uc-qa-icon { font-size: 28px; flex-shrink: 0; }
.uc-qa-title { font-size: 14px; font-weight: 600; }
.uc-qa-desc { font-size: 12px; color: var(--uc-text2); margin-top: 2px; }
.uc-vl { background: var(--uc-surface); border: 1px solid var(--uc-border); border-radius: 12px; overflow: hidden; }
.uc-vr { display: flex; justify-content: space-between; padding: 10px 16px; font-size: 13px; border-bottom: 1px solid var(--uc-border); }
.uc-vr:last-child { border-bottom: none; }
.uc-vn { font-weight: 500; }
.uc-vc { color: var(--uc-text2); background: var(--uc-bg2); padding: 1px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }

/* Update List */
.uc-ul { display: flex; flex-direction: column; gap: 16px; }
.uc-ul-hdr { display: flex; align-items: center; gap: 12px; }
.uc-ul-hdr h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.uc-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.uc-search {
  flex: 1; min-width: 200px; padding: 8px 14px; border: 1px solid var(--uc-border); border-radius: 8px;
  font-size: 14px; background: var(--uc-surface); color: var(--uc-text); outline: none;
}
.uc-search:focus { border-color: var(--uc-accent); }
.uc-fg { display: flex; border: 1px solid var(--uc-border); border-radius: 8px; overflow: hidden; }
.uc-fb {
  padding: 8px 14px; font-size: 13px; border: none; background: var(--uc-surface); color: var(--uc-text2);
  cursor: pointer; font-family: inherit; border-right: 1px solid var(--uc-border); margin: 0;
}
.uc-fb:last-child { border-right: none; }
.uc-fb.active { background: var(--uc-accent); color: #fff; }
.uc-fb:hover:not(.active) { background: var(--uc-bg2); }
.uc-sel-bar {
  display: flex; justify-content: space-between; align-items: center; padding: 10px 14px;
  background: var(--uc-bg2); border-radius: 8px; font-size: 13px;
}
.uc-sel-lbl { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--uc-text2); }
.uc-empty { text-align: center; padding: 48px 24px; color: var(--uc-text2); font-size: 15px; }
.uc-tbl { border: 1px solid var(--uc-border); border-radius: 12px; overflow: hidden; }
.uc-th, .uc-tr {
  display: grid; grid-template-columns: 40px 2fr 100px 30px 100px 100px 80px 1fr;
  gap: 4px; padding: 10px 14px; align-items: center;
}
.uc-th {
  background: var(--uc-bg2); font-size: 12px; font-weight: 600; color: var(--uc-text2);
  text-transform: uppercase; letter-spacing: .04em;
}
.uc-tr { border-top: 1px solid var(--uc-border); font-size: 13px; }
.uc-tr:hover { background: var(--uc-bg2); }
.uc-tr.uc-sel { background: rgba(25,118,210,.04); }
.uc-cc { display: flex; align-items: center; justify-content: center; }
.uc-cn { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.uc-an { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.uc-as { font-size: 11px; color: var(--uc-text3); font-family: monospace; }
.uc-ar { text-align: center; color: var(--uc-text3); }
.uc-mono { font-family: monospace; font-size: 12px; }
.uc-rb { font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 600; text-transform: uppercase; }
.uc-rb-low { background: rgba(56,142,60,.1); color: #388e3c; }
.uc-rb-medium { background: rgba(245,124,0,.1); color: #f57c00; }
.uc-rb-high { background: rgba(211,47,47,.1); color: #d32f2f; }
.uc-rb-critical { background: rgba(136,14,79,.1); color: #880e4f; }
.uc-cv { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--uc-text2); font-size: 12px; }

/* Dialog */
.uc-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center;
  justify-content: center; z-index: 1000; backdrop-filter: blur(2px);
}
.uc-dlg {
  background: var(--uc-surface); border-radius: 16px; padding: 28px; width: 520px; max-width: 90vw;
  max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 16px 48px rgba(0,0,0,.2);
}
.uc-dlg-title { margin: 0 0 4px; font-size: 18px; font-weight: 600; }
.uc-dlg-sub { margin: 0 0 16px; font-size: 14px; color: var(--uc-text2); }
.uc-dlg-warn {
  padding: 10px 14px; background: rgba(211,47,47,.06); border: 1px solid rgba(211,47,47,.2);
  border-radius: 8px; font-size: 13px; color: var(--uc-red); margin-bottom: 16px;
}
.uc-dlg-list { flex: 1; overflow-y: auto; border: 1px solid var(--uc-border); border-radius: 10px; margin-bottom: 20px; max-height: 300px; }
.uc-dlg-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-bottom: 1px solid var(--uc-border); font-size: 13px; }
.uc-dlg-item:last-child { border-bottom: none; }
.uc-dlg-name { flex: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.uc-dlg-ver { font-family: monospace; font-size: 12px; color: var(--uc-text2); white-space: nowrap; }
.uc-dlg-lvl { font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 600; text-transform: uppercase; }
.uc-lv-major { background: rgba(211,47,47,.1); color: #d32f2f; }
.uc-lv-minor { background: rgba(25,118,210,.1); color: #1976d2; }
.uc-lv-patch { background: rgba(56,142,60,.1); color: #388e3c; }
.uc-dlg-acts { display: flex; justify-content: flex-end; gap: 10px; }

/* Progress */
.uc-pm { display: flex; flex-direction: column; gap: 20px; }
.uc-pm-hdr { display: flex; align-items: center; gap: 12px; }
.uc-pm-hdr h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.uc-timer { font-family: monospace; font-size: 16px; color: var(--uc-text2); background: var(--uc-bg2); padding: 4px 14px; border-radius: 8px; }
.uc-pcard { background: var(--uc-surface); border: 1px solid var(--uc-border); border-radius: 14px; padding: 24px; }
.uc-prow { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 14px; }
.uc-pstate { font-size: 18px; font-weight: 600; }
.uc-ppct { font-size: 28px; font-weight: 700; font-family: monospace; }
.uc-ptrack { height: 10px; background: var(--uc-bg2); border-radius: 99px; overflow: hidden; }
.uc-pfill { height: 100%; background: var(--uc-accent); border-radius: 99px; transition: width .5s ease; }
.uc-pfill.done { background: var(--uc-green)!important; }
.uc-pfill.err { background: var(--uc-red)!important; }
.uc-perr { margin-top: 10px; font-size: 13px; color: var(--uc-red); font-weight: 500; }
.uc-pills { display: flex; flex-wrap: wrap; gap: 8px; }
.uc-pill { display: flex; align-items: center; gap: 8px; background: var(--uc-surface); border: 1px solid var(--uc-border); border-radius: 10px; padding: 8px 14px; font-size: 13px; }
.uc-pill b { font-weight: 500; }
.uc-pill span { font-family: monospace; font-size: 11px; color: var(--uc-text3); }
.uc-log { background: #1a1a2e; border-radius: 12px; padding: 14px; max-height: 320px; overflow-y: auto; font-family: monospace; font-size: 12px; }
.uc-log-empty { color: #555; padding: 20px; text-align: center; }
.uc-le { display: flex; gap: 10px; padding: 3px 0; line-height: 1.5; }
.uc-le-t { color: #666; flex-shrink: 0; }
.uc-le-info .uc-le-m { color: #b0bec5; }
.uc-le-success .uc-le-m { color: #66bb6a; }
.uc-le-error .uc-le-m { color: #ef5350; }
.uc-le-warning .uc-le-m { color: #ffa726; }
.uc-pdone { display: flex; justify-content: center; gap: 12px; }
.uc-sec { font-size: 15px; font-weight: 600; margin: 0 0 10px; }

/* History */
.uc-fhdr { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.uc-fhdr h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.uc-fl { display: flex; flex-direction: column; border: 1px solid var(--uc-border); border-radius: 12px; overflow: hidden; }
.uc-fi { display: flex; gap: 14px; padding: 16px 18px; background: var(--uc-surface); border-bottom: 1px solid var(--uc-border); }
.uc-fi:last-child { border-bottom: none; }
.uc-fi-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
.uc-fi-body { flex: 1; min-width: 0; }
.uc-fi-name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
.uc-fi-meta { display: flex; gap: 12px; font-size: 12px; color: var(--uc-text3); }
.uc-fi-st { font-weight: 500; }
.uc-fi-msg { margin-top: 6px; font-size: 13px; color: var(--uc-text2); line-height: 1.4; }
.uc-s-ok .uc-fi-icon { background: rgba(56,142,60,.1); color: #388e3c; }
.uc-s-ok .uc-fi-st { color: #388e3c; }
.uc-s-err .uc-fi-icon { background: rgba(211,47,47,.1); color: #d32f2f; }
.uc-s-err .uc-fi-st { color: #d32f2f; }
.uc-s-run .uc-fi-icon { background: rgba(25,118,210,.1); color: #1976d2; }
.uc-s-run .uc-fi-st { color: #1976d2; }
.uc-s-oth .uc-fi-icon { background: var(--uc-bg2); color: var(--uc-text3); }

.uc-hidden { display: none !important; }
</style>

<div class="uc-root" id="ucRoot">
  <nav class="uc-nav">
    <div class="uc-nav-brand">Update Center</div>
    <div class="uc-nav-links" id="ucNav"></div>
  </nav>
  <div id="ucError" class="uc-error uc-hidden"><span id="ucErrTxt"></span><button class="uc-btn uc-btn-g" id="ucErrDismiss">Dismiss</button></div>
  <main class="uc-content" id="ucContent"></main>
</div>
<div id="ucDialog"></div>

<script>
(function () {
  'use strict';

  var S = {
    view: 'dashboard', updates: [], loading: true, error: null, lastRefresh: null,
    installing: false, batchId: null, installQueue: [], selected: {},
    filter: 'all', search: '', pPct: 0, pState: 'Preparing...', pErr: '', pDone: false, logs: [], elapsed: 0,
    serverStart: null
  };
  var clientStart = 0, pollT = null, tickT = null;

  function getToken() {
    if (window.g_ck) return window.g_ck;
    if (window.NOW && window.NOW.g_ck) return window.NOW.g_ck;
    try { var m = document.cookie.match(/g_ck=([^;]+)/); if (m) return m[1]; } catch(e){}
    return '';
  }

  function hdrs() {
    var h = { Accept: 'application/json', 'Content-Type': 'application/json' };
    var t = getToken(); if (t) h['X-UserToken'] = t;
    return h;
  }

  function api(url, opts) {
    return fetch(url, Object.assign({ headers: hdrs(), credentials: 'same-origin' }, opts || {}))
      .then(function(r) {
        if (!r.ok) return r.json().catch(function(){return{};}).then(function(e){throw new Error((e.error&&e.error.message)||'HTTP '+r.status);});
        return r.json();
      });
  }

  function fv(f){return f&&(f.value!==undefined?f.value:f);}
  function fd(f){return f&&(f.display_value!==undefined?f.display_value:fv(f));}
  function cmpVer(a,b){var f=(a||'0.0.0').split('.'),t=(b||'0.0.0').split('.');if(f[0]!==t[0])return'major';if(f[1]!==t[1])return'minor';return'patch';}
  function risk(l){return l==='major'?'high':l==='minor'?'medium':'low';}
  function fmtDur(s){if(s<60)return s+'s';var m=Math.floor(s/60),r=s%60;if(m<60)return m+'m '+r+'s';return Math.floor(m/60)+'h '+(m%60)+'m';}

  function getUpdates() {
    return api('/api/now/table/sys_store_app?sysparm_display_value=all&sysparm_fields=sys_id,name,scope,version,vendor,active&sysparm_query=active=true^update_available=true^ORDERBYname')
      .then(function(d){
        var apps=d.result||[];
        return Promise.all(apps.map(function(app){
          return api('/api/now/table/sys_app_version?sysparm_display_value=all&sysparm_fields=sys_id,version,source_app_id,publish_date&sysparm_query=source_app_id='+fv(app.sys_id)+'^ORDERBYversion')
            .then(function(v){return{app:app,ver:v.result||[]};}).catch(function(){return{app:app,ver:[]};});
        }));
      }).then(function(res){
        return res.filter(function(r){return r.ver.length>0;}).map(function(r){
          var a=r.app,l=r.ver[r.ver.length-1],iv=fv(a.version),lv=fv(l.version),lev=cmpVer(iv,lv);
          return{id:fv(a.sys_id),name:fd(a.name),scope:fv(a.scope),iv:iv,lv:lv,lvId:fv(l.sys_id),level:lev,risk:risk(lev),vendor:fd(a.vendor)||'ServiceNow',date:fd(l.publish_date)||''};
        });
      });
  }

  function fireInstallAjax(apps) {
    if (typeof GlideAjax === 'undefined') {
      console.warn('[UC] GlideAjax not available');
      return;
    }
    var payload = JSON.stringify(apps.map(function(a) {
      return { id: a.id, name: a.name, lv: a.lv, iv: a.iv };
    }));
    console.log('[UC] Firing installBatch with', payload);
    try {
      var ga = new GlideAjax('x_g_s7s_updater.UpdateCenterInstaller');
      ga.addParam('sysparm_name', 'installBatch');
      ga.addParam('sysparm_apps', payload);
      ga.getXMLAnswer(function(answer) {
        console.log('[UC] GlideAjax callback answer:', answer);
        if (answer && answer.length > 10 && !S.batchId) {
          S.batchId = answer;
          addLog('GlideAjax returned worker ID', 'success');
        }
      });
    } catch (e) {
      console.error('[UC] GlideAjax error:', e);
    }
  }

  function findRecentWorker() {
    var q = 'nameSTARTSWITHUpdate Center^ORDERBYDESCsys_created_on';
    return api('/api/now/table/sys_progress_worker?sysparm_display_value=all&sysparm_fields=sys_id,state,name,sys_created_on&sysparm_query=' + encodeURIComponent(q) + '&sysparm_limit=1')
      .then(function(d) {
        var r = (d.result || [])[0];
        return r ? fv(r.sys_id) : null;
      }).catch(function() { return null; });
  }

  function pollWorker(id) {
    return api('/api/now/table/sys_progress_worker/' + id + '?sysparm_display_value=all&sysparm_fields=sys_id,state,percent_complete,message,error_message,output_summary,sys_created_on')
      .then(function(d) { return d.result; });
  }

  function el(t,a,c){var e=document.createElement(t);if(a)Object.keys(a).forEach(function(k){if(k==='className')e.className=a[k];else if(k.indexOf('on')===0)e.addEventListener(k.substring(2),a[k]);else if(k==='disabled'&&a[k])e.disabled=true;else if(k==='checked')e.checked=a[k];else if(k==='type'||k==='placeholder'||k==='value')e[k]=a[k];else e.setAttribute(k,a[k]);});if(c!=null){if(Array.isArray(c))c.forEach(function(x){if(x!=null)e.appendChild(typeof x==='string'?document.createTextNode(x):x);});else if(typeof c==='string')e.textContent=c;else e.appendChild(c);}return e;}

  function renderNav(){
    var n=document.getElementById('ucNav');n.innerHTML='';
    [['dashboard','Dashboard'],['updates','Updates'],['history','History']].forEach(function(t){
      n.appendChild(el('button',{className:'uc-nav-link'+(S.view===t[0]?' active':''),onclick:function(){nav(t[0]);}},t[1]));
    });
    if(S.installing)n.appendChild(el('button',{className:'uc-nav-link uc-nav-pulse',onclick:function(){nav('progress');}},'Installing...'));
  }

  function renderErr(){
    var e=document.getElementById('ucError');
    if(S.error){e.classList.remove('uc-hidden');document.getElementById('ucErrTxt').textContent=S.error;}else e.classList.add('uc-hidden');
  }

  function renderDash(){
    var u=S.updates,tot=u.length,maj=u.filter(function(x){return x.level==='major';}).length;
    var min=u.filter(function(x){return x.level==='minor';}).length,pat=u.filter(function(x){return x.level==='patch';}).length;
    var hi=u.filter(function(x){return x.risk==='high'||x.risk==='critical';}).length;
    var vd={};u.forEach(function(x){vd[x.vendor]=(vd[x.vendor]||0)+1;});
    var ve=Object.keys(vd).map(function(k){return[k,vd[k]];}).sort(function(a,b){return b[1]-a[1];});
    return el('div',{className:'uc-dash'},[
      el('div',{className:'uc-dash-hdr'},[
        el('div',null,[el('h2',{className:'uc-dash-title'},'Update Center'),S.lastRefresh?el('span',{className:'uc-dash-sub'},'Last checked: '+S.lastRefresh.toLocaleTimeString()):null]),
        el('div',{className:'uc-dash-acts'},[
          el('button',{className:'uc-btn uc-btn-s',disabled:S.loading,onclick:refresh},S.loading?'Scanning...':'Check for Updates'),
          S.installing?el('button',{className:'uc-btn uc-btn-p',onclick:function(){nav('progress');}},'View Progress'):null])]),
      el('div',{className:'uc-stats'},[
        el('button',{className:'uc-stat uc-c-accent',onclick:function(){nav('updates');}},[el('div',{className:'uc-stat-val'},''+tot),el('div',{className:'uc-stat-lbl'},'Updates Available'),el('div',{className:'uc-stat-hint'},'Click to view all')]),
        el('div',{className:'uc-stat uc-c-red'},[el('div',{className:'uc-stat-val'},''+maj),el('div',{className:'uc-stat-lbl'},'Major'),el('div',{className:'uc-stat-tag uc-tag-r'},'Breaking changes possible')]),
        el('div',{className:'uc-stat uc-c-blue'},[el('div',{className:'uc-stat-val'},''+min),el('div',{className:'uc-stat-lbl'},'Minor'),el('div',{className:'uc-stat-tag uc-tag-b'},'New features')]),
        el('div',{className:'uc-stat uc-c-green'},[el('div',{className:'uc-stat-val'},''+pat),el('div',{className:'uc-stat-lbl'},'Patch'),el('div',{className:'uc-stat-tag uc-tag-g'},'Bug fixes')])]),
      hi>0?el('div',{className:'uc-risk-ban'},[el('span',null,'\u26A0'),el('span',null,[el('strong',null,''+hi),document.createTextNode(' update'+(hi>1?'s':'')+' flagged as elevated risk.')])]):null,
      el('div',{className:'uc-qa'},[el('h3',null,'Quick Actions'),el('div',{className:'uc-qa-grid'},[
        el('button',{className:'uc-qa-card',disabled:tot===0,onclick:function(){nav('updates');}},[el('div',{className:'uc-qa-icon'},'\uD83D\uDCE6'),el('div',null,[el('div',{className:'uc-qa-title'},'Install Updates'),el('div',{className:'uc-qa-desc'},'Select and batch install store app updates')])]),
        el('button',{className:'uc-qa-card',onclick:function(){nav('history');}},[el('div',{className:'uc-qa-icon'},'\uD83D\uDCCB'),el('div',null,[el('div',{className:'uc-qa-title'},'Installation History'),el('div',{className:'uc-qa-desc'},'View past batch installation activity')])])])]),
      ve.length>0?el('div',{className:'uc-vs'},[el('h3',null,'By Vendor'),el('div',{className:'uc-vl'},ve.map(function(v){return el('div',{className:'uc-vr'},[el('span',{className:'uc-vn'},v[0]),el('span',{className:'uc-vc'},''+v[1])]);}))])  :null
    ]);
  }

  function renderList(){
    var fl=S.updates.filter(function(u){if(S.filter!=='all'&&u.level!==S.filter)return false;if(S.search){var q=S.search.toLowerCase();if(u.name.toLowerCase().indexOf(q)===-1&&u.scope.toLowerCase().indexOf(q)===-1)return false;}return true;});
    var sc=Object.keys(S.selected).filter(function(k){return S.selected[k];}).length;
    var allSel=fl.length>0&&fl.every(function(u){return S.selected[u.id];});
    function li(l){return l==='major'?'\uD83D\uDD34':l==='minor'?'\uD83D\uDFE1':'\uD83D\uDFE2';}
    return el('div',{className:'uc-ul'},[
      el('div',{className:'uc-ul-hdr'},[el('button',{className:'uc-btn uc-btn-g',onclick:function(){nav('dashboard');'}},'\u2190 Back'),el('h2',null,'Available Updates'),el('div',{style:'width:60px'})]),
      el('div',{className:'uc-toolbar'},[
        el('input',{type:'text',className:'uc-search',placeholder:'Search apps...',value:S.search,oninput:function(e){S.search=e.target.value;render();}}),
        el('div',{className:'uc-fg'},['all','major','minor','patch'].map(function(f){return el('button',{className:'uc-fb'+(S.filter===f?' active':''),onclick:function(){S.filter=f;render();}},f==='all'?'All':f.charAt(0).toUpperCase()+f.slice(1));}))]),
      el('div',{className:'uc-sel-bar'},[
        el('label',{className:'uc-sel-lbl'},[el('input',{type:'checkbox',checked:allSel,onchange:function(){fl.forEach(function(u){S.selected[u.id]=!allSel;});render();}}),el('span',null,sc+' of '+S.updates.length+' selected')]),
        el('button',{className:'uc-btn uc-btn-p',disabled:sc===0||S.loading,onclick:showDlg},'Install Selected ('+sc+')')]),
      S.loading?el('div',{className:'uc-empty'},'Scanning for updates...'):
      fl.length===0?el('div',{className:'uc-empty'},S.updates.length===0?'All apps are up to date!':'No updates match your filter.'):
      el('div',{className:'uc-tbl'},[
        el('div',{className:'uc-th'},[el('div',{className:'uc-cc'}),el('div',null,'Application'),el('div',null,'Installed'),el('div'),el('div',null,'Available'),el('div',null,'Type'),el('div',null,'Risk'),el('div',null,'Vendor')])
      ].concat(fl.map(function(u){
        return el('div',{className:'uc-tr'+(S.selected[u.id]?' uc-sel':'')},[
          el('div',{className:'uc-cc'},el('input',{type:'checkbox',checked:!!S.selected[u.id],onchange:function(){S.selected[u.id]=!S.selected[u.id];render();}})),
          el('div',{className:'uc-cn'},[el('span',{className:'uc-an'},u.name),el('span',{className:'uc-as'},u.scope)]),
          el('div',{className:'uc-mono'},u.iv),el('div',{className:'uc-ar'},'\u2192'),el('div',{className:'uc-mono'},u.lv),
          el('div',null,li(u.level)+' '+u.level),
          el('div',null,el('span',{className:'uc-rb uc-rb-'+u.risk},u.risk)),
          el('div',{className:'uc-cv'},u.vendor)]);
      })))
    ]);
  }

  function showDlg(){
    var sel=S.updates.filter(function(u){return S.selected[u.id];});if(!sel.length)return;
    var mc=sel.filter(function(u){return u.level==='major';}).length,c=document.getElementById('ucDialog');c.innerHTML='';
    c.appendChild(el('div',{className:'uc-overlay',onclick:function(){c.innerHTML='';}},
      el('div',{className:'uc-dlg',onclick:function(e){e.stopPropagation();}},[
        el('h3',{className:'uc-dlg-title'},'Confirm Batch Installation'),
        el('p',{className:'uc-dlg-sub'},[document.createTextNode('You are about to install '),el('strong',null,''+sel.length),document.createTextNode(' update'+(sel.length>1?'s':'')+'.')]),
        mc>0?el('div',{className:'uc-dlg-warn'},'\u26A0 '+mc+' major update'+(mc>1?'s':'')+'. May contain breaking changes.'):null,
        el('div',{className:'uc-dlg-list'},sel.map(function(u){return el('div',{className:'uc-dlg-item'},[el('span',{className:'uc-dlg-name'},u.name),el('span',{className:'uc-dlg-ver'},u.iv+' \u2192 '+u.lv),el('span',{className:'uc-dlg-lvl uc-lv-'+u.level},u.level)]);})),
        el('div',{className:'uc-dlg-acts'},[el('button',{className:'uc-btn uc-btn-s',onclick:function(){c.innerHTML='';}},'Cancel'),
          el('button',{className:'uc-btn uc-btn-p',onclick:function(){c.innerHTML='';doInstall(sel);}},'Install '+sel.length+' Update'+(sel.length>1?'s':''))])])));
  }

  function renderProg(){
    var f=S.pDone,e=S.pErr,sc=f?(e?'var(--uc-red)':'var(--uc-green)'):'var(--uc-accent)';
    return el('div',{className:'uc-pm'},[
      el('div',{className:'uc-pm-hdr'},[el('button',{className:'uc-btn uc-btn-g',onclick:function(){nav('dashboard');'}},'\u2190 Back'),el('h2',null,'Installation Progress'),el('div',{className:'uc-timer'},fmtDur(S.elapsed))]),
      el('div',{className:'uc-pcard'},[
        el('div',{className:'uc-prow'},[el('div',{className:'uc-pstate',style:'color:'+sc},f?(e?'\u2717 Failed':'\u2713 Complete'):S.pState),el('div',{className:'uc-ppct'},S.pPct+'%')]),
        el('div',{className:'uc-ptrack'},el('div',{className:'uc-pfill'+(f&&!e?' done':'')+(e?' err':''),style:'width:'+S.pPct+'%'})),
        e?el('div',{className:'uc-perr'},e):null]),
      el('div',null,[el('h3',{className:'uc-sec'},'Applications ('+S.installQueue.length+')'),
        el('div',{className:'uc-pills'},S.installQueue.map(function(u){return el('div',{className:'uc-pill'},[el('b',null,u.name),el('span',null,u.iv+' \u2192 '+u.lv)]);}))]),
      el('div',null,[el('h3',{className:'uc-sec'},'Activity Log'),
        el('div',{className:'uc-log',id:'ucLog'},S.logs.length===0?[el('div',{className:'uc-log-empty'},'Waiting for activity...')]
          :S.logs.map(function(l){return el('div',{className:'uc-le uc-le-'+l.type},[el('span',{className:'uc-le-t'},l.time),el('span',{className:'uc-le-m'},l.message)]);}))]),
      f?el('div',{className:'uc-pdone'},[el('button',{className:'uc-btn uc-btn-s',onclick:function(){nav('dashboard');}},'Return to Dashboard'),el('button',{className:'uc-btn uc-btn-p',onclick:function(){nav('updates');}},'Check for More Updates')]):null
    ]);
  }

  function renderHist(){
    var c=el('div',null,[el('div',{className:'uc-fhdr'},[el('button',{className:'uc-btn uc-btn-g',onclick:function(){nav('dashboard');'}},'\u2190 Back'),el('h2',null,'Installation History'),el('button',{className:'uc-btn uc-btn-s',onclick:loadHist},'Refresh')]),el('div',{id:'ucHist'},el('div',{className:'uc-empty'},'Loading history...'))]);
    loadHist();return c;
  }

  function loadHist(){
    api('/api/now/table/sys_progress_worker?sysparm_display_value=all&sysparm_fields=sys_id,name,state,percent_complete,message,sys_created_on&sysparm_query=nameSTARTSWITHBatch^ORnameSTARTSWITHUpdate Center^ORDERBYDESCsys_created_on&sysparm_limit=50')
      .then(function(d){
        var es=(d.result||[]).map(function(r){return{name:fd(r.name)||'Unknown',state:fd(r.state)||'',msg:fd(r.message)||'',created:fd(r.sys_created_on)||''};});
        var h=document.getElementById('ucHist');if(!h)return;
        if(!es.length){h.innerHTML='<div class="uc-empty">No installation history found.</div>';return;}
        h.innerHTML='';
        h.appendChild(el('div',{className:'uc-fl'},es.map(function(e){
          var s=e.state.toLowerCase(),cls=s.indexOf('success')>-1||s.indexOf('complete')>-1?'uc-s-ok':s.indexOf('fail')>-1||s.indexOf('error')>-1?'uc-s-err':s.indexOf('running')>-1?'uc-s-run':'uc-s-oth';
          var ic=cls==='uc-s-ok'?'\u2713':cls==='uc-s-err'?'\u2717':cls==='uc-s-run'?'\u27F3':'\u2022';
          return el('div',{className:'uc-fi '+cls},[el('div',{className:'uc-fi-icon'},ic),el('div',{className:'uc-fi-body'},[el('div',{className:'uc-fi-name'},e.name),el('div',{className:'uc-fi-meta'},[e.created?el('span',null,e.created):null,el('span',{className:'uc-fi-st'},e.state)]),e.msg?el('div',{className:'uc-fi-msg'},e.msg):null])]);
        })));
      }).catch(function(){var h=document.getElementById('ucHist');if(h)h.innerHTML='<div class="uc-empty">Failed to load history.</div>';});
  }

  function nav(v){S.view=v;render();}
  function refresh(){S.loading=true;S.error=null;render();getUpdates().then(function(d){S.updates=d;S.lastRefresh=new Date();}).catch(function(e){S.error='Failed to load updates: '+(e.message||'Unknown');}).finally(function(){S.loading=false;render();});}

  function saveSession(){
    try{sessionStorage.setItem('uc_session',JSON.stringify({
      batchId:S.batchId,installQueue:S.installQueue,clientStart:clientStart
    }));}catch(e){}
  }
  function clearSession(){try{sessionStorage.removeItem('uc_session');}catch(e){}}

  function addLog(m,t){
    S.logs.push({time:new Date().toLocaleTimeString(),message:m,type:t||'info'});
    var logEl=document.getElementById('ucLog');
    if(logEl){
      var entry=S.logs[S.logs.length-1];
      if(S.logs.length===1) logEl.innerHTML='';
      logEl.appendChild(el('div',{className:'uc-le uc-le-'+entry.type},[el('span',{className:'uc-le-t'},entry.time),el('span',{className:'uc-le-m'},entry.message)]));
      logEl.scrollTop=logEl.scrollHeight;
    }
  }

  function isStateDone(p){
    var raw=(''+(fv(p.state)||'')).toLowerCase();
    var disp=(''+(fd(p.state)||'')).toLowerCase();
    return raw==='2'||raw==='complete'||raw==='successful'||disp.indexOf('complete')>-1||disp.indexOf('success')>-1;
  }
  function isStateFailed(p){
    var raw=(''+(fv(p.state)||'')).toLowerCase();
    var disp=(''+(fd(p.state)||'')).toLowerCase();
    return raw==='3'||raw==='4'||raw==='error'||raw==='failed'||raw==='cancelled'
      ||disp.indexOf('error')>-1||disp.indexOf('fail')>-1||disp.indexOf('cancel')>-1;
  }

  function doInstall(sel){
    S.installQueue=sel;S.installing=true;S.view='progress';
    S.pPct=0;S.pState='Preparing...';S.pErr='';S.pDone=false;S.logs=[];
    S.elapsed=0;S.serverStart=null;S.batchId=null;
    clientStart=Date.now();
    if(tickT)clearInterval(tickT);
    if(pollT)clearInterval(pollT);
    startTick();
    render();

    setTimeout(function(){
      addLog('Triggering batch installation ('+sel.length+' app'+(sel.length>1?'s':'')+')...');
      fireInstallAjax(sel);
      addLog('Install request sent to server');
      addLog('Searching for progress worker...','info');
      searchForWorker(0);
    },100);
  }

  function startTick(){
    if(tickT)clearInterval(tickT);
    tickT=setInterval(function(){
      if(S.serverStart) S.elapsed=Math.floor((Date.now()-S.serverStart.getTime())/1000);
      else S.elapsed=Math.floor((Date.now()-clientStart)/1000);
      var t=document.querySelector('.uc-timer');
      if(t)t.textContent=fmtDur(S.elapsed);
    },1000);
  }

  function searchForWorker(attempt){
    if(S.batchId){saveSession();startPoll();return;}
    findRecentWorker().then(function(id){
      if(id){
        S.batchId=id;
        saveSession();
        addLog('Found progress worker: '+id.substring(0,8)+'...','success');
        startPoll();
      } else if(attempt<10){
        var delay=attempt<3?2000:3000;
        if(attempt>0) addLog('Worker not found yet, retrying... ('+(attempt+1)+'/10)','info');
        setTimeout(function(){searchForWorker(attempt+1);},delay);
      } else {
        addLog('Could not locate progress worker.','error');
        addLog('The install may have completed. Check History tab.','warning');
        S.pDone=true;S.pState='Unknown';
        if(tickT)clearInterval(tickT);
        clearSession();
        render();
      }
    }).catch(function(e){
      addLog('Search error: '+e.message,'warning');
      if(attempt<10) setTimeout(function(){searchForWorker(attempt+1);},3000);
    });
  }

  function startPoll(){
    var lastMsg='';
    console.log('[UC] Polling worker:', S.batchId);
    addLog('Monitoring installation progress...','info');
    function doPoll(){
      if(!S.batchId)return;
      pollWorker(S.batchId).then(function(p){
        var pct=parseInt(fv(p.percent_complete))||0;
        S.pPct=pct;

        var created=fd(p.sys_created_on);
        if(created&&!S.serverStart){
          try{S.serverStart=new Date(created);}catch(e){}
        }

        var stateDisplay=fd(p.state)||fv(p.state)||'Running';
        var msg=fd(p.message)||fv(p.message)||'';

        if(msg&&msg!==lastMsg){lastMsg=msg;addLog(msg);}
        S.pState=stateDisplay;

        if(isStateDone(p)){
          clearInterval(pollT);if(tickT)clearInterval(tickT);
          S.pPct=100;S.pDone=true;
          addLog('Batch installation completed!','success');
          S.installing=false;S.batchId=null;
          clearSession();
          render();refresh();
        } else if(isStateFailed(p)){
          clearInterval(pollT);if(tickT)clearInterval(tickT);
          S.pDone=true;
          var errMsg=fd(p.error_message)||fv(p.error_message)||'Installation encountered an issue.';
          S.pErr=errMsg;
          addLog('Installation issue: '+errMsg,'error');
          clearSession();
          render();
        } else {
          updateProgressUI();
        }
      }).catch(function(e){
        console.error('[UC] Poll error:', e);
        addLog('Poll error: '+e.message,'warning');
      });
    }
    doPoll();
    pollT=setInterval(doPoll,2500);
  }

  function updateProgressUI(){
    var pctEl=document.querySelector('.uc-ppct');
    if(pctEl)pctEl.textContent=S.pPct+'%';
    var fillEl=document.querySelector('.uc-pfill');
    if(fillEl)fillEl.style.width=S.pPct+'%';
    var stateEl=document.querySelector('.uc-pstate');
    if(stateEl)stateEl.textContent=S.pState;
  }

  function render(){renderNav();renderErr();var c=document.getElementById('ucContent');
    if(S.view==='dashboard'){c.innerHTML='';c.appendChild(renderDash());}
    else if(S.view==='updates'){c.innerHTML='';c.appendChild(renderList());}
    else if(S.view==='progress'){c.innerHTML='';c.appendChild(renderProg());}
    else if(S.view==='history'){c.innerHTML='';c.appendChild(renderHist());}
  }

  function resumeSession(){
    try{
      var raw=sessionStorage.getItem('uc_session');
      if(!raw) return false;
      var sess=JSON.parse(raw);
      if(!sess.batchId) return false;
      S.batchId=sess.batchId;
      S.installQueue=sess.installQueue||[];
      S.installing=true;
      S.view='progress';
      S.pPct=0;S.pState='Resuming...';S.pDone=false;S.pErr='';S.logs=[];
      clientStart=sess.clientStart||Date.now();
      startTick();
      render();
      addLog('Resuming monitoring of active installation...','info');
      startPoll();
      return true;
    }catch(e){return false;}
  }

  document.getElementById('ucErrDismiss').addEventListener('click',function(){S.error=null;renderErr();});
  if(!resumeSession()){render();refresh();}else{refresh();}
})();
</script>
