<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Center</title>
<style>
:root {
  --bg: #f5f6fa;
  --bg-secondary: #ebedf3;
  --surface: #ffffff;
  --border: #e0e2ea;
  --text-primary: #1a1a2e;
  --text-secondary: #5a5d70;
  --text-tertiary: #8b8ea3;
  --accent: #1976d2;
  --accent-hover: #1565c0;
  --risk-high: #d32f2f;
  --risk-medium: #f57c00;
  --level-minor: #1976d2;
  --level-patch: #388e3c;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg); color: var(--text-primary); font-size: 14px; line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}
.app-shell { min-height: 100vh; display: flex; flex-direction: column; }
.app-nav {
  display: flex; align-items: center; gap: 24px; padding: 0 32px; height: 56px;
  background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
}
.nav-brand { font-size: 16px; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
.nav-links { display: flex; gap: 2px; }
.nav-link {
  padding: 6px 14px; font-size: 13px; font-weight: 500; color: var(--text-secondary);
  background: none; border: none; border-radius: 6px; cursor: pointer; font-family: inherit;
  transition: background .15s, color .15s;
}
.nav-link:hover { background: var(--bg-secondary); color: var(--text-primary); }
.nav-link.active { background: rgba(25,118,210,.08); color: var(--accent); }
.nav-progress { color: var(--accent)!important; font-weight: 600!important; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
.active-pulse { animation: pulse 2s infinite; }
.app-error {
  display: flex; align-items: center; justify-content: space-between; padding: 10px 32px;
  background: rgba(211,47,47,.06); border-bottom: 1px solid rgba(211,47,47,.15);
  color: var(--risk-high); font-size: 13px;
}
.app-content { flex: 1; padding: 28px 32px; max-width: 1200px; width: 100%; margin: 0 auto; }
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 8px 18px; font-size: 13px; font-weight: 500; border: none; border-radius: 8px;
  cursor: pointer; font-family: inherit; white-space: nowrap;
  transition: background .15s, box-shadow .15s, opacity .15s;
}
.btn:disabled { opacity: .5; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); box-shadow: 0 2px 6px rgba(25,118,210,.25); }
.btn-secondary { background: var(--bg-secondary); color: var(--text-primary); }
.btn-secondary:hover:not(:disabled) { background: var(--border); }
.btn-ghost { background: none; color: var(--text-secondary); padding: 6px 10px; }
.btn-ghost:hover:not(:disabled) { background: var(--bg-secondary); color: var(--text-primary); }

/* Dashboard */
.dashboard { display: flex; flex-direction: column; gap: 24px; }
.dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
.dashboard-title { font-size: 24px; font-weight: 600; margin: 0; }
.last-refresh { font-size: 12px; color: var(--text-secondary); }
.dashboard-actions { display: flex; gap: 8px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
  padding: 20px; text-align: center; width: 100%; font-family: inherit; color: inherit;
  transition: box-shadow .15s, transform .15s; cursor: default;
}
button.stat-card { cursor: pointer; border: 1px solid var(--border); }
button.stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,.08); transform: translateY(-1px); }
.stat-value { font-size: 36px; font-weight: 700; line-height: 1; margin-bottom: 6px; }
.stat-total .stat-value { color: var(--accent); }
.stat-major .stat-value { color: var(--risk-high); }
.stat-minor .stat-value { color: var(--level-minor); }
.stat-patch .stat-value { color: var(--level-patch); }
.stat-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
.stat-hint { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; }
.stat-tag { font-size: 11px; margin-top: 6px; padding: 2px 8px; border-radius: 99px; display: inline-block; }
.tag-major { background: rgba(211,47,47,.08); color: var(--risk-high); }
.tag-minor { background: rgba(25,118,210,.08); color: var(--level-minor); }
.tag-patch { background: rgba(56,142,60,.08); color: var(--level-patch); }
.risk-banner {
  display: flex; align-items: center; gap: 10px; padding: 14px 18px; font-size: 14px;
  background: rgba(211,47,47,.06); border: 1px solid rgba(211,47,47,.2); border-radius: 10px; color: var(--risk-high);
}
.quick-actions h3, .vendor-summary h3 { font-size: 16px; font-weight: 600; margin: 0 0 12px; }
.action-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
.action-card {
  display: flex; align-items: center; gap: 14px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px 18px; cursor: pointer; text-align: left; width: 100%;
  font-family: inherit; color: inherit; transition: box-shadow .15s, border-color .15s;
}
.action-card:hover:not(:disabled) { border-color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.action-card:disabled { opacity: .5; cursor: not-allowed; }
.action-icon { font-size: 28px; flex-shrink: 0; }
.action-title { font-size: 14px; font-weight: 600; }
.action-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.vendor-list { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.vendor-row { display: flex; justify-content: space-between; padding: 10px 16px; font-size: 13px; border-bottom: 1px solid var(--border); }
.vendor-row:last-child { border-bottom: none; }
.vendor-name { font-weight: 500; }
.vendor-count { color: var(--text-secondary); background: var(--bg-secondary); padding: 1px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }

/* Update List */
.update-list { display: flex; flex-direction: column; gap: 16px; }
.update-list-header { display: flex; align-items: center; gap: 12px; }
.update-list-header h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.update-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.search-input {
  flex: 1; min-width: 200px; padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px;
  font-size: 14px; background: var(--surface); color: var(--text-primary); outline: none;
}
.search-input:focus { border-color: var(--accent); }
.filter-group { display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.filter-btn {
  padding: 8px 14px; font-size: 13px; border: none; background: var(--surface); color: var(--text-secondary);
  cursor: pointer; font-family: inherit; border-right: 1px solid var(--border);
}
.filter-btn:last-child { border-right: none; }
.filter-btn.active { background: var(--accent); color: #fff; }
.filter-btn:hover:not(.active) { background: var(--bg-secondary); }
.selection-bar {
  display: flex; justify-content: space-between; align-items: center; padding: 10px 14px;
  background: var(--bg-secondary); border-radius: 8px; font-size: 13px;
}
.select-all-label { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-secondary); }
.empty-state, .loading-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); font-size: 15px; }
.update-table { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.table-header, .table-row {
  display: grid; grid-template-columns: 40px 2fr 100px 30px 100px 100px 80px 1fr;
  gap: 4px; padding: 10px 14px; align-items: center;
}
.table-header {
  background: var(--bg-secondary); font-size: 12px; font-weight: 600; color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: .04em;
}
.table-row { border-top: 1px solid var(--border); font-size: 13px; transition: background .1s; }
.table-row:hover { background: var(--bg-secondary); }
.table-row.row-selected { background: rgba(25,118,210,.04); }
.col-check { display: flex; align-items: center; justify-content: center; }
.col-name { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.app-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.app-scope { font-size: 11px; color: var(--text-tertiary); font-family: monospace; }
.col-arrow { text-align: center; color: var(--text-tertiary); }
.mono { font-family: monospace; font-size: 12px; }
.risk-badge { font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 600; text-transform: uppercase; }
.risk-low { background: rgba(56,142,60,.1); color: #388e3c; }
.risk-medium { background: rgba(245,124,0,.1); color: #f57c00; }
.risk-high { background: rgba(211,47,47,.1); color: #d32f2f; }
.risk-critical { background: rgba(136,14,79,.1); color: #880e4f; }
.col-vendor { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); font-size: 12px; }

/* Confirm Dialog */
.dialog-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center;
  justify-content: center; z-index: 1000; backdrop-filter: blur(2px);
}
.dialog-box {
  background: var(--surface); border-radius: 16px; padding: 28px; width: 520px; max-width: 90vw;
  max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 16px 48px rgba(0,0,0,.2);
}
.dialog-title { margin: 0 0 4px; font-size: 18px; font-weight: 600; }
.dialog-subtitle { margin: 0 0 16px; font-size: 14px; color: var(--text-secondary); }
.dialog-warning {
  padding: 10px 14px; background: rgba(211,47,47,.06); border: 1px solid rgba(211,47,47,.2);
  border-radius: 8px; font-size: 13px; color: var(--risk-high); margin-bottom: 16px;
}
.dialog-list { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 20px; max-height: 300px; }
.dialog-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
.dialog-item:last-child { border-bottom: none; }
.dialog-app-name { flex: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.dialog-version { font-family: monospace; font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
.dialog-level { font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 600; text-transform: uppercase; }
.level-major { background: rgba(211,47,47,.1); color: #d32f2f; }
.level-minor { background: rgba(25,118,210,.1); color: #1976d2; }
.level-patch { background: rgba(56,142,60,.1); color: #388e3c; }
.dialog-actions { display: flex; justify-content: flex-end; gap: 10px; }

/* Progress */
.progress-monitor { display: flex; flex-direction: column; gap: 20px; }
.progress-header { display: flex; align-items: center; gap: 12px; }
.progress-header h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.progress-timer { font-family: monospace; font-size: 16px; color: var(--text-secondary); background: var(--bg-secondary); padding: 4px 14px; border-radius: 8px; }
.progress-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; }
.progress-status-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 14px; }
.progress-state { font-size: 18px; font-weight: 600; }
.progress-pct { font-size: 28px; font-weight: 700; font-family: monospace; }
.progress-bar-track { height: 10px; background: var(--bg-secondary); border-radius: 99px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--accent); border-radius: 99px; transition: width .5s ease; }
.bar-done { background: var(--level-patch)!important; }
.bar-error { background: var(--risk-high)!important; }
.progress-message { margin-top: 10px; font-size: 13px; color: var(--text-secondary); }
.progress-error { margin-top: 10px; font-size: 13px; color: var(--risk-high); font-weight: 500; }
.app-pill-list { display: flex; flex-wrap: wrap; gap: 8px; }
.app-pill { display: flex; align-items: center; gap: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 8px 14px; font-size: 13px; }
.pill-name { font-weight: 500; }
.pill-ver { font-family: monospace; font-size: 11px; color: var(--text-tertiary); }
.log-container { background: #1a1a2e; border-radius: 12px; padding: 14px; max-height: 320px; overflow-y: auto; font-family: monospace; font-size: 12px; }
.log-empty { color: #555; padding: 20px; text-align: center; }
.log-entry { display: flex; gap: 10px; padding: 3px 0; line-height: 1.5; }
.log-time { color: #666; flex-shrink: 0; }
.log-info .log-msg { color: #b0bec5; }
.log-success .log-msg { color: #66bb6a; }
.log-error .log-msg { color: #ef5350; }
.log-warning .log-msg { color: #ffa726; }
.progress-done-actions { display: flex; justify-content: center; gap: 12px; }

/* History */
.feed-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.feed-header h2 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; }
.feed-loading, .feed-empty { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
.feed-list { display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.feed-item { display: flex; gap: 14px; padding: 16px 18px; background: var(--surface); border-bottom: 1px solid var(--border); }
.feed-item:last-child { border-bottom: none; }
.feed-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
.feed-content { flex: 1; min-width: 0; }
.feed-item-name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
.feed-item-meta { display: flex; gap: 12px; font-size: 12px; color: var(--text-tertiary); }
.feed-state { font-weight: 500; }
.state-success .feed-icon { background: rgba(56,142,60,.1); color: #388e3c; }
.state-success .feed-state { color: #388e3c; }
.state-error .feed-icon { background: rgba(211,47,47,.1); color: #d32f2f; }
.state-error .feed-state { color: #d32f2f; }
.state-running .feed-icon { background: rgba(25,118,210,.1); color: #1976d2; }
.state-running .feed-state { color: #1976d2; }
.state-other .feed-icon { background: var(--bg-secondary); color: var(--text-tertiary); }
.feed-item-message { margin-top: 6px; font-size: 13px; color: var(--text-secondary); line-height: 1.4; }

.section-title { font-size: 15px; font-weight: 600; margin: 0 0 10px; }
.hidden { display: none !important; }
</style>
</head>
<body>
<div id="root" class="app-shell">
  <nav class="app-nav">
    <div class="nav-brand">Update Center</div>
    <div class="nav-links" id="navLinks"></div>
  </nav>
  <div id="appError" class="app-error hidden"><span id="errorText"></span><button class="btn btn-ghost" id="dismissError">Dismiss</button></div>
  <main class="app-content" id="appContent"></main>
</div>
<div id="dialogContainer"></div>
<script>
(function () {
  'use strict';

  var state = {
    view: 'dashboard',
    updates: [],
    loading: true,
    error: null,
    lastRefresh: null,
    installing: false,
    batchId: null,
    installQueue: [],
    selected: {},
    filter: 'all',
    search: '',
    progressPercent: 0,
    progressState: 'Preparing...',
    progressError: '',
    progressFinished: false,
    logs: [],
    elapsed: 0
  };

  var startTime = 0;
  var pollTimer = null;
  var elapsedTimer = null;

  // --- API helpers ---
  function headers() {
    return { Accept: 'application/json', 'Content-Type': 'application/json', 'X-UserToken': window.g_ck || '' };
  }

  function fetchJson(url, opts) {
    return fetch(url, Object.assign({ headers: headers() }, opts || {}))
      .then(function (r) {
        if (!r.ok) return r.json().catch(function () { return {}; }).then(function (e) { throw new Error((e.error && e.error.message) || 'HTTP ' + r.status); });
        return r.json();
      });
  }

  function fv(field) { return field && (field.value !== undefined ? field.value : field); }
  function fd(field) { return field && (field.display_value !== undefined ? field.display_value : fv(field)); }

  function compareVersions(a, b) {
    var from = (a || '0.0.0').split('.'), to = (b || '0.0.0').split('.');
    if (from[0] !== to[0]) return 'major';
    if (from[1] !== to[1]) return 'minor';
    return 'patch';
  }

  function assessRisk(level) {
    if (level === 'major') return 'high';
    if (level === 'minor') return 'medium';
    return 'low';
  }

  function formatDuration(sec) {
    if (sec < 60) return sec + 's';
    var m = Math.floor(sec / 60), s = sec % 60;
    if (m < 60) return m + 'm ' + s + 's';
    return Math.floor(m / 60) + 'h ' + (m % 60) + 'm';
  }

  // --- Data fetching ---
  function getAvailableUpdates() {
    var params = 'sysparm_display_value=all&sysparm_fields=sys_id,name,scope,version,vendor,active&sysparm_query=active=true^update_available=true^ORDERBYname';
    return fetchJson('/api/now/table/sys_store_app?' + params)
      .then(function (data) {
        var apps = data.result || [];
        var promises = apps.map(function (app) {
          var appId = fv(app.sys_id);
          var vParams = 'sysparm_display_value=all&sysparm_fields=sys_id,version,source_app_id,publish_date&sysparm_query=source_app_id=' + appId + '^ORDERBYversion';
          return fetchJson('/api/now/table/sys_app_version?' + vParams)
            .then(function (vData) { return { app: app, versions: vData.result || [] }; })
            .catch(function () { return { app: app, versions: [] }; });
        });
        return Promise.all(promises);
      })
      .then(function (results) {
        return results.filter(function (r) { return r.versions.length > 0; }).map(function (r) {
          var app = r.app, latest = r.versions[r.versions.length - 1];
          var installed = fv(app.version), latestVer = fv(latest.version);
          var level = compareVersions(installed, latestVer);
          return {
            appSysId: fv(app.sys_id), appName: fd(app.name), scope: fv(app.scope),
            installedVersion: installed, latestVersion: latestVer,
            latestVersionSysId: fv(latest.sys_id), updateLevel: level, riskLevel: assessRisk(level),
            vendor: fd(app.vendor) || 'ServiceNow', publishDate: fd(latest.publish_date) || '',
          };
        });
      });
  }

  function startBatchInstall(updates) {
    var manifest = {
      name: 'Update Center Batch Install',
      notes: 'Batch installation of ' + updates.length + ' app(s) via Update Center',
      packages: updates.map(function (u) {
        return { id: u.appSysId, type: 'application', load_demo_data: false, requested_version: u.latestVersion, notes: u.appName + ' ' + u.installedVersion + ' \u2192 ' + u.latestVersion };
      })
    };
    return fetchJson('/api/sn_cicd/app/batch/install', { method: 'POST', body: JSON.stringify(manifest) })
      .then(function (data) { return data.result && data.result.id || ''; });
  }

  function getBatchProgress(id) {
    return fetchJson('/api/sn_cicd/progress/' + id).then(function (d) { return d.result; });
  }

  // --- Rendering ---
  function el(tag, attrs, children) {
    var e = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function (k) {
      if (k === 'className') e.className = attrs[k];
      else if (k === 'onclick' || k === 'onchange' || k === 'oninput') e.addEventListener(k.substring(2), attrs[k]);
      else if (k === 'disabled' && attrs[k]) e.disabled = true;
      else if (k === 'checked') e.checked = attrs[k];
      else if (k === 'type' || k === 'placeholder' || k === 'value') e[k] = attrs[k];
      else if (k === 'htmlFor') e.htmlFor = attrs[k];
      else e.setAttribute(k, attrs[k]);
    });
    if (children !== undefined && children !== null) {
      if (Array.isArray(children)) children.forEach(function (c) { if (c != null) e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
      else if (typeof children === 'string') e.textContent = children;
      else e.appendChild(children);
    }
    return e;
  }

  function renderNav() {
    var nav = document.getElementById('navLinks');
    nav.innerHTML = '';
    var tabs = [['dashboard', 'Dashboard'], ['updates', 'Updates'], ['history', 'History']];
    tabs.forEach(function (t) {
      nav.appendChild(el('button', { className: 'nav-link' + (state.view === t[0] ? ' active' : ''), onclick: function () { navigate(t[0]); } }, t[1]));
    });
    if (state.installing) {
      nav.appendChild(el('button', { className: 'nav-link nav-progress active-pulse', onclick: function () { navigate('progress'); } }, 'Installing...'));
    }
  }

  function renderError() {
    var errEl = document.getElementById('appError');
    if (state.error) { errEl.classList.remove('hidden'); document.getElementById('errorText').textContent = state.error; }
    else errEl.classList.add('hidden');
  }

  function renderDashboard() {
    var u = state.updates;
    var total = u.length, major = u.filter(function (x) { return x.updateLevel === 'major'; }).length;
    var minor = u.filter(function (x) { return x.updateLevel === 'minor'; }).length;
    var patch = u.filter(function (x) { return x.updateLevel === 'patch'; }).length;
    var highRisk = u.filter(function (x) { return x.riskLevel === 'high' || x.riskLevel === 'critical'; }).length;

    var vendors = {};
    u.forEach(function (x) { vendors[x.vendor] = (vendors[x.vendor] || 0) + 1; });
    var vendorEntries = Object.keys(vendors).map(function (k) { return [k, vendors[k]]; }).sort(function (a, b) { return b[1] - a[1]; });

    var content = el('div', { className: 'dashboard' }, [
      el('div', { className: 'dashboard-header' }, [
        el('div', null, [
          el('h2', { className: 'dashboard-title' }, 'Update Center'),
          state.lastRefresh ? el('span', { className: 'last-refresh' }, 'Last checked: ' + state.lastRefresh.toLocaleTimeString()) : null
        ]),
        el('div', { className: 'dashboard-actions' }, [
          el('button', { className: 'btn btn-secondary', disabled: state.loading, onclick: refreshUpdates }, state.loading ? 'Scanning...' : 'Check for Updates'),
          state.installing ? el('button', { className: 'btn btn-primary', onclick: function () { navigate('progress'); } }, 'View Progress') : null
        ])
      ]),
      el('div', { className: 'stats-grid' }, [
        el('button', { className: 'stat-card stat-total', onclick: function () { navigate('updates'); } }, [
          el('div', { className: 'stat-value' }, '' + total),
          el('div', { className: 'stat-label' }, 'Updates Available'),
          el('div', { className: 'stat-hint' }, 'Click to view all')
        ]),
        el('div', { className: 'stat-card stat-major' }, [
          el('div', { className: 'stat-value' }, '' + major),
          el('div', { className: 'stat-label' }, 'Major'),
          el('div', { className: 'stat-tag tag-major' }, 'Breaking changes possible')
        ]),
        el('div', { className: 'stat-card stat-minor' }, [
          el('div', { className: 'stat-value' }, '' + minor),
          el('div', { className: 'stat-label' }, 'Minor'),
          el('div', { className: 'stat-tag tag-minor' }, 'New features')
        ]),
        el('div', { className: 'stat-card stat-patch' }, [
          el('div', { className: 'stat-value' }, '' + patch),
          el('div', { className: 'stat-label' }, 'Patch'),
          el('div', { className: 'stat-tag tag-patch' }, 'Bug fixes')
        ])
      ]),
      highRisk > 0 ? el('div', { className: 'risk-banner' }, [
        el('span', null, '\u26A0'),
        el('span', null, [el('strong', null, '' + highRisk), document.createTextNode(' update' + (highRisk > 1 ? 's' : '') + ' flagged as elevated risk. Review before installing.')])
      ]) : null,
      el('div', { className: 'quick-actions' }, [
        el('h3', null, 'Quick Actions'),
        el('div', { className: 'action-cards' }, [
          el('button', { className: 'action-card', disabled: total === 0, onclick: function () { navigate('updates'); } }, [
            el('div', { className: 'action-icon' }, '\uD83D\uDCE6'),
            el('div', null, [el('div', { className: 'action-title' }, 'Install Updates'), el('div', { className: 'action-desc' }, 'Select and batch install store app updates')])
          ]),
          el('button', { className: 'action-card', onclick: function () { navigate('history'); } }, [
            el('div', { className: 'action-icon' }, '\uD83D\uDCCB'),
            el('div', null, [el('div', { className: 'action-title' }, 'Installation History'), el('div', { className: 'action-desc' }, 'View past batch installation activity')])
          ])
        ])
      ]),
      vendorEntries.length > 0 ? el('div', { className: 'vendor-summary' }, [
        el('h3', null, 'By Vendor'),
        el('div', { className: 'vendor-list' }, vendorEntries.map(function (v) {
          return el('div', { className: 'vendor-row' }, [el('span', { className: 'vendor-name' }, v[0]), el('span', { className: 'vendor-count' }, '' + v[1])]);
        }))
      ]) : null
    ]);
    return content;
  }

  function renderUpdateList() {
    var filtered = state.updates.filter(function (u) {
      if (state.filter !== 'all' && u.updateLevel !== state.filter) return false;
      if (state.search) {
        var q = state.search.toLowerCase();
        if (u.appName.toLowerCase().indexOf(q) === -1 && u.scope.toLowerCase().indexOf(q) === -1) return false;
      }
      return true;
    });
    var selectedCount = Object.keys(state.selected).filter(function (k) { return state.selected[k]; }).length;
    var allVisibleSelected = filtered.length > 0 && filtered.every(function (u) { return state.selected[u.appSysId]; });

    function levelIcon(l) { return l === 'major' ? '\uD83D\uDD34' : l === 'minor' ? '\uD83D\uDFE1' : '\uD83D\uDFE2'; }

    return el('div', { className: 'update-list' }, [
      el('div', { className: 'update-list-header' }, [
        el('button', { className: 'btn btn-ghost', onclick: function () { navigate('dashboard'); } }, '\u2190 Back'),
        el('h2', null, 'Available Updates'), el('div', { style: 'width:60px' })
      ]),
      el('div', { className: 'update-toolbar' }, [
        el('input', { type: 'text', className: 'search-input', placeholder: 'Search apps...', value: state.search, oninput: function (e) { state.search = e.target.value; render(); } }),
        el('div', { className: 'filter-group' }, ['all', 'major', 'minor', 'patch'].map(function (f) {
          return el('button', { className: 'filter-btn' + (state.filter === f ? ' active' : ''), onclick: function () { state.filter = f; render(); } },
            f === 'all' ? 'All' : f.charAt(0).toUpperCase() + f.slice(1));
        }))
      ]),
      el('div', { className: 'selection-bar' }, [
        el('label', { className: 'select-all-label' }, [
          el('input', { type: 'checkbox', checked: allVisibleSelected, onchange: function () {
            filtered.forEach(function (u) { state.selected[u.appSysId] = !allVisibleSelected; }); render();
          } }),
          el('span', null, selectedCount + ' of ' + state.updates.length + ' selected')
        ]),
        el('button', { className: 'btn btn-primary', disabled: selectedCount === 0 || state.loading, onclick: showConfirmDialog }, 'Install Selected (' + selectedCount + ')')
      ]),
      state.loading ? el('div', { className: 'loading-state' }, 'Scanning for updates...') :
      filtered.length === 0 ? el('div', { className: 'empty-state' }, state.updates.length === 0 ? 'All apps are up to date!' : 'No updates match your filter.') :
      el('div', { className: 'update-table' }, [
        el('div', { className: 'table-header' }, [
          el('div', { className: 'col-check' }), el('div', null, 'Application'), el('div', null, 'Installed'),
          el('div'), el('div', null, 'Available'), el('div', null, 'Type'), el('div', null, 'Risk'), el('div', null, 'Vendor')
        ])
      ].concat(filtered.map(function (u) {
        return el('div', { className: 'table-row' + (state.selected[u.appSysId] ? ' row-selected' : '') }, [
          el('div', { className: 'col-check' }, el('input', { type: 'checkbox', checked: !!state.selected[u.appSysId], onchange: function () { state.selected[u.appSysId] = !state.selected[u.appSysId]; render(); } })),
          el('div', { className: 'col-name' }, [el('span', { className: 'app-name' }, u.appName), el('span', { className: 'app-scope' }, u.scope)]),
          el('div', { className: 'mono' }, u.installedVersion),
          el('div', { className: 'col-arrow' }, '\u2192'),
          el('div', { className: 'mono' }, u.latestVersion),
          el('div', null, levelIcon(u.updateLevel) + ' ' + u.updateLevel),
          el('div', null, el('span', { className: 'risk-badge risk-' + u.riskLevel }, u.riskLevel)),
          el('div', { className: 'col-vendor' }, u.vendor)
        ]);
      })))
    ]);
  }

  function showConfirmDialog() {
    var sel = state.updates.filter(function (u) { return state.selected[u.appSysId]; });
    if (sel.length === 0) return;
    var majorCount = sel.filter(function (u) { return u.updateLevel === 'major'; }).length;
    var container = document.getElementById('dialogContainer');
    container.innerHTML = '';
    container.appendChild(
      el('div', { className: 'dialog-backdrop', onclick: function () { container.innerHTML = ''; } },
        el('div', { className: 'dialog-box', onclick: function (e) { e.stopPropagation(); } }, [
          el('h3', { className: 'dialog-title' }, 'Confirm Batch Installation'),
          el('p', { className: 'dialog-subtitle' }, [
            document.createTextNode('You are about to install '), el('strong', null, '' + sel.length),
            document.createTextNode(' update' + (sel.length > 1 ? 's' : '') + '.')
          ]),
          majorCount > 0 ? el('div', { className: 'dialog-warning' }, '\u26A0 ' + majorCount + ' major version update' + (majorCount > 1 ? 's' : '') + ' included. Major updates may contain breaking changes.') : null,
          el('div', { className: 'dialog-list' }, sel.map(function (u) {
            return el('div', { className: 'dialog-item' }, [
              el('span', { className: 'dialog-app-name' }, u.appName),
              el('span', { className: 'dialog-version' }, u.installedVersion + ' \u2192 ' + u.latestVersion),
              el('span', { className: 'dialog-level level-' + u.updateLevel }, u.updateLevel)
            ]);
          })),
          el('div', { className: 'dialog-actions' }, [
            el('button', { className: 'btn btn-secondary', onclick: function () { container.innerHTML = ''; } }, 'Cancel'),
            el('button', { className: 'btn btn-primary', onclick: function () { container.innerHTML = ''; handleInstall(sel); } }, 'Install ' + sel.length + ' Update' + (sel.length > 1 ? 's' : ''))
          ])
        ])
      )
    );
  }

  function renderProgress() {
    var f = state.progressFinished, err = state.progressError;
    var statusColor = f ? (err ? 'var(--risk-high)' : 'var(--level-patch)') : 'var(--accent)';

    return el('div', { className: 'progress-monitor' }, [
      el('div', { className: 'progress-header' }, [
        el('button', { className: 'btn btn-ghost', onclick: function () { navigate('dashboard'); } }, '\u2190 Back'),
        el('h2', null, 'Installation Progress'),
        el('div', { className: 'progress-timer' }, formatDuration(state.elapsed))
      ]),
      el('div', { className: 'progress-card' }, [
        el('div', { className: 'progress-status-row' }, [
          el('div', { className: 'progress-state', style: 'color:' + statusColor }, f ? (err ? '\u2717 Failed' : '\u2713 Complete') : state.progressState),
          el('div', { className: 'progress-pct' }, state.progressPercent + '%')
        ]),
        el('div', { className: 'progress-bar-track' }, el('div', {
          className: 'progress-bar-fill' + (f && !err ? ' bar-done' : '') + (err ? ' bar-error' : ''),
          style: 'width:' + state.progressPercent + '%'
        })),
        err ? el('div', { className: 'progress-error' }, err) : null
      ]),
      el('div', null, [
        el('h3', { className: 'section-title' }, 'Applications (' + state.installQueue.length + ')'),
        el('div', { className: 'app-pill-list' }, state.installQueue.map(function (u) {
          return el('div', { className: 'app-pill' }, [el('span', { className: 'pill-name' }, u.appName), el('span', { className: 'pill-ver' }, u.installedVersion + ' \u2192 ' + u.latestVersion)]);
        }))
      ]),
      el('div', null, [
        el('h3', { className: 'section-title' }, 'Activity Log'),
        el('div', { className: 'log-container', id: 'logContainer' },
          state.logs.length === 0 ? [el('div', { className: 'log-empty' }, 'Waiting for activity...')]
          : state.logs.map(function (entry) {
            return el('div', { className: 'log-entry log-' + entry.type }, [el('span', { className: 'log-time' }, entry.time), el('span', { className: 'log-msg' }, entry.message)]);
          })
        )
      ]),
      f ? el('div', { className: 'progress-done-actions' }, [
        el('button', { className: 'btn btn-secondary', onclick: function () { navigate('dashboard'); } }, 'Return to Dashboard'),
        el('button', { className: 'btn btn-primary', onclick: function () { navigate('updates'); } }, 'Check for More Updates')
      ]) : null
    ]);
  }

  function renderHistory() {
    var container = el('div', null, [
      el('div', { className: 'feed-header' }, [
        el('button', { className: 'btn btn-ghost', onclick: function () { navigate('dashboard'); } }, '\u2190 Back'),
        el('h2', null, 'Installation History'),
        el('button', { className: 'btn btn-secondary', onclick: loadHistory }, 'Refresh')
      ]),
      el('div', { id: 'historyContent' }, el('div', { className: 'feed-loading' }, 'Loading history...'))
    ]);
    loadHistory();
    return container;
  }

  function loadHistory() {
    var params = 'sysparm_display_value=all&sysparm_fields=sys_id,name,state,percent_complete,message,sys_created_on&sysparm_query=nameSTARTSWITHBatch^ORnameSTARTSWITHUpdate Center^ORDERBYDESCsys_created_on&sysparm_limit=50';
    fetchJson('/api/now/table/sys_progress_worker?' + params)
      .then(function (data) {
        var entries = (data.result || []).map(function (r) {
          return { name: fd(r.name) || 'Unknown', state: fd(r.state) || '', pct: parseInt(fv(r.percent_complete)) || 0, message: fd(r.message) || '', created: fd(r.sys_created_on) || '' };
        });
        var hc = document.getElementById('historyContent');
        if (!hc) return;
        if (entries.length === 0) { hc.innerHTML = '<div class="feed-empty">No installation history found.</div>'; return; }
        hc.innerHTML = '';
        var list = el('div', { className: 'feed-list' }, entries.map(function (e) {
          var s = e.state.toLowerCase();
          var cls = s.indexOf('success') > -1 || s.indexOf('complete') > -1 ? 'state-success' : s.indexOf('fail') > -1 || s.indexOf('error') > -1 ? 'state-error' : s.indexOf('running') > -1 ? 'state-running' : 'state-other';
          var icon = cls === 'state-success' ? '\u2713' : cls === 'state-error' ? '\u2717' : cls === 'state-running' ? '\u27F3' : '\u2022';
          return el('div', { className: 'feed-item ' + cls }, [
            el('div', { className: 'feed-icon' }, icon),
            el('div', { className: 'feed-content' }, [
              el('div', { className: 'feed-item-name' }, e.name),
              el('div', { className: 'feed-item-meta' }, [e.created ? el('span', null, e.created) : null, el('span', { className: 'feed-state' }, e.state)]),
              e.message ? el('div', { className: 'feed-item-message' }, e.message) : null
            ])
          ]);
        }));
        hc.appendChild(list);
      })
      .catch(function () {
        var hc = document.getElementById('historyContent');
        if (hc) hc.innerHTML = '<div class="feed-empty">Failed to load history.</div>';
      });
  }

  // --- Actions ---
  function navigate(view) { state.view = view; render(); }

  function refreshUpdates() {
    state.loading = true; state.error = null; render();
    getAvailableUpdates()
      .then(function (data) { state.updates = data; state.lastRefresh = new Date(); })
      .catch(function (err) { state.error = 'Failed to load updates: ' + (err.message || 'Unknown error'); })
      .finally(function () { state.loading = false; render(); });
  }

  function handleInstall(selected) {
    state.installQueue = selected; state.installing = true; state.view = 'progress';
    state.progressPercent = 0; state.progressState = 'Preparing...'; state.progressError = '';
    state.progressFinished = false; state.logs = []; state.elapsed = 0;
    startTime = Date.now(); render();
    addLog('Batch installation started (' + selected.length + ' app' + (selected.length > 1 ? 's' : '') + ')');
    startBatchInstall(selected)
      .then(function (id) { state.batchId = id; startPolling(); })
      .catch(function (err) {
        state.error = 'Failed to start batch install: ' + (err.message || 'Unknown error');
        state.installing = false; state.view = 'updates'; render();
      });
    elapsedTimer = setInterval(function () { state.elapsed = Math.floor((Date.now() - startTime) / 1000); render(); }, 1000);
  }

  function addLog(msg, type) {
    state.logs.push({ time: new Date().toLocaleTimeString(), message: msg, type: type || 'info' });
    render();
    setTimeout(function () { var lc = document.getElementById('logContainer'); if (lc) lc.scrollTop = lc.scrollHeight; }, 50);
  }

  function startPolling() {
    pollTimer = setInterval(function () {
      if (!state.batchId) return;
      getBatchProgress(state.batchId)
        .then(function (p) {
          var pct = parseInt(p.percent_complete) || 0;
          state.progressPercent = pct;
          if (p.state !== state.progressState) { state.progressState = p.state; addLog('Status: ' + p.state); }
          if (p.state === 'Successful' || p.state === 'Complete') {
            clearInterval(pollTimer); clearInterval(elapsedTimer);
            state.progressPercent = 100; state.progressFinished = true;
            addLog('Batch installation completed successfully!', 'success');
            state.installing = false; state.batchId = null; refreshUpdates();
          } else if (p.state === 'Failed' || p.state === 'Error') {
            clearInterval(pollTimer); clearInterval(elapsedTimer);
            state.progressFinished = true; state.progressError = 'Installation failed. Check output for details.';
            addLog('Installation failed', 'error');
          }
          render();
        })
        .catch(function (err) { addLog('Polling error: ' + err.message, 'warning'); });
    }, 3000);
  }

  // --- Main render ---
  function render() {
    renderNav(); renderError();
    var content = document.getElementById('appContent');
    if (state.view === 'dashboard') { content.innerHTML = ''; content.appendChild(renderDashboard()); }
    else if (state.view === 'updates') { content.innerHTML = ''; content.appendChild(renderUpdateList()); }
    else if (state.view === 'progress') { content.innerHTML = ''; content.appendChild(renderProgress()); }
    else if (state.view === 'history') { content.innerHTML = ''; content.appendChild(renderHistory()); }
  }

  // --- Init ---
  document.getElementById('dismissError').addEventListener('click', function () { state.error = null; renderError(); });
  render();
  refreshUpdates();
})();
</script>
</body>
</html>
